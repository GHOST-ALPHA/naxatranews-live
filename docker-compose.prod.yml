version: '3.8'

# Production Docker Compose with Nginx
# Usage: docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d

services:
  # Nginx Reverse Proxy
  nginx:
    image: nginx:alpine
    container_name: bawal_nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"  # For SSL (configure SSL certificates separately)
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro  # SSL certificates (create this directory)
      - nginx_cache:/var/cache/nginx
      - nginx_logs:/var/log/nginx
    depends_on:
      - app
    networks:
      - bawal_network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Override app service for production
  app:
    ports:
      - "127.0.0.1:3333:3333"  # Only accessible via nginx
    labels:
      - "traefik.enable=false"  # Disable if using Traefik

volumes:
  nginx_cache:
    driver: local
  nginx_logs:
    driver: local
